<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>BART Station Display</title>

        <style type="text/tailwindcss">
            @font-face {
                font-family: "Berkeley Mono";
                src: url("/fonts/BerkeleyMono-Regular.woff2") format("woff2");
                font-weight: 400;
                font-style: normal;
            }

            @font-face {
                font-family: "Berkeley Mono";
                src: url("/fonts/BerkeleyMono-Bold.woff2") format("woff2");
                font-weight: 700;
                font-style: normal;
            }

            @theme {
                --font-mono: "Berkeley Mono", "Courier New", monospace;
            }

            @layer base {
                * {
                    font-family: var(--font-mono);
                }

                body {
                    background: #000000;
                    color: #ff6600;
                }
            }

            /* Dot Matrix LED Effect */
            .dot-matrix {
                background: #1a1a1a;
                border: 4px solid #333;
                border-radius: 8px;
                padding: 20px;
                box-shadow:
                    inset 0 0 20px rgba(0, 0, 0, 0.8),
                    0 0 20px rgba(255, 102, 0, 0.3);
            }

            .led-text {
                color: #ff6600;
                text-shadow:
                    0 0 5px #ff6600,
                    0 0 10px #ff6600,
                    0 0 15px #ff6600;
                letter-spacing: 0.1em;
                font-weight: 700;
            }

            .led-text-dim {
                color: #663300;
                text-shadow:
                    0 0 2px #663300;
                letter-spacing: 0.1em;
            }

            .platform-display {
                min-height: 200px;
            }

            /* Scanline effect */
            .dot-matrix::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    to bottom,
                    transparent 50%,
                    rgba(0, 0, 0, 0.1) 50%
                );
                background-size: 100% 4px;
                pointer-events: none;
                opacity: 0.3;
            }

            /* Arrival status colors */
            .arriving { animation: blink 1s infinite; }
            @keyframes blink {
                0%, 49% { opacity: 1; }
                50%, 100% { opacity: 0.3; }
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    </head>
    <body class="p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="mb-6 text-center">
                <div class="text-2xl font-bold led-text mb-2" id="station-name">
                    LOADING...
                </div>
                <div class="text-sm led-text-dim" id="current-time">
                    --:--:--
                </div>
            </header>

            <!-- Platform Displays -->
            <div id="platforms" class="grid gap-6">
                <div class="led-text-dim text-center">
                    Loading station data...
                </div>
            </div>
        </div>

        <script>
            // Get station from URL
            const pathParts = window.location.pathname.split('/');
            const stationCode = pathParts[pathParts.length - 1].toUpperCase();

            // Update clock
            function updateClock() {
                const now = new Date();
                document.getElementById("current-time").textContent =
                    now.toLocaleTimeString();
            }
            setInterval(updateClock, 1000);
            updateClock();

            // Fetch departures for all platforms
            async function updateDepartures() {
                try {
                    const response = await fetch(`/bart/departures/${stationCode}`);
                    const data = await response.json();

                    // Update station name
                    document.getElementById("station-name").textContent =
                        data.station_name?.toUpperCase() || data.station;

                    // Group departures by platform
                    const platformMap = new Map();

                    data.departures.forEach(dep => {
                        const platform = dep.platform || 'N/A';
                        if (!platformMap.has(platform)) {
                            platformMap.set(platform, []);
                        }
                        platformMap.get(platform).push(dep);
                    });

                    // Sort platforms
                    const platforms = Array.from(platformMap.keys()).sort();

                    // Render platform displays
                    let html = '';

                    if (platforms.length === 0) {
                        html = '<div class="dot-matrix text-center"><div class="led-text text-xl">NO DEPARTURES</div></div>';
                    } else {
                        html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';

                        platforms.forEach(platform => {
                            const departures = platformMap.get(platform).slice(0, 3); // Show next 3 trains

                            html += '<div class="dot-matrix platform-display relative">';
                            html += `<div class="led-text text-sm mb-4 border-b border-orange-900 pb-2">PLATFORM ${platform}</div>`;

                            departures.forEach((dep, idx) => {
                                const destination = dep.destination.toUpperCase();
                                const routeName = dep.route?.route_name || '';
                                const minutes = dep.minutes;

                                let timeDisplay = '';
                                if (minutes === null) {
                                    timeDisplay = 'SCHEDULED';
                                } else if (minutes <= 0) {
                                    timeDisplay = 'BOARDING';
                                } else if (minutes === 1) {
                                    timeDisplay = '1 MIN';
                                } else {
                                    timeDisplay = `${minutes} MIN`;
                                }

                                const isArriving = minutes !== null && minutes <= 1;
                                const blinkClass = isArriving ? 'arriving' : '';

                                html += '<div class="mb-6">';
                                html += `<div class="led-text text-2xl mb-1 ${blinkClass}">${destination}</div>`;
                                html += '<div class="flex justify-between items-end">';
                                html += `<div class="led-text-dim text-sm">${routeName}</div>`;
                                html += `<div class="led-text text-xl ${blinkClass}">${timeDisplay}</div>`;
                                html += '</div>';
                                if (dep.delay > 60) {
                                    html += `<div class="led-text-dim text-xs mt-1">DELAY ${Math.round(dep.delay / 60)} MIN</div>`;
                                }
                                html += '</div>';
                            });

                            // Fill empty slots
                            for (let i = departures.length; i < 3; i++) {
                                html += '<div class="mb-6">';
                                html += '<div class="led-text-dim text-2xl mb-1">................</div>';
                                html += '<div class="led-text-dim text-sm">NO DATA</div>';
                                html += '</div>';
                            }

                            html += '</div>';
                        });

                        html += '</div>';
                    }

                    document.getElementById("platforms").innerHTML = html;

                } catch (error) {
                    console.error('Error fetching departures:', error);
                    document.getElementById("platforms").innerHTML =
                        '<div class="dot-matrix text-center"><div class="led-text text-xl">ERROR LOADING DATA</div></div>';
                }
            }

            // Initial load and refresh every 10 seconds
            updateDepartures();
            setInterval(updateDepartures, 10000);
        </script>
    </body>
</html>
